<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="dark">
<title>FOX2 Onboarding Test</title>
<style>
:root {
  color-scheme: dark;
}
* { box-sizing: border-box; }
body { 
  background:#000; color:#fff; margin:0; padding:0; 
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  overflow:hidden;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  position: fixed;
  inset: 0;
}
.container { 
  max-width:480px; 
  margin:0 auto; 
  padding:12px; 
  height:100%;
  display:flex; 
  flex-direction:column;
  gap: 8px;
}
.screen { 
  display:none; 
  flex:1; 
  flex-direction:column;
  min-height: 0;
  overflow: hidden;
}
.screen.active { display:flex; }

.welcome { 
  text-align:center; 
  display:flex;
  flex-direction:column;
  justify-content:center;
  flex:1;
  overflow:auto;
}
.logo { 
  font-size:56px; font-weight:700; margin-bottom:12px; 
  background:linear-gradient(135deg,#00ffff,#ff6b00);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}
.tagline { font-size:20px; opacity:.7; margin-bottom:24px; }

.content-text {
  flex: 1;
  overflow-y: auto;
  padding: 0 4px;
  line-height: 1.5;
}
.content-text p {
  margin: 0 0 16px 0;
  font-size: 19px;
  opacity: 0.9;
}
.content-text strong {
  color: #00ffff;
  font-weight: 600;
}

/* Swipeable card system - VERTICAL */
.card-container {
  position: relative;
  width: 100%;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  margin-top: 12px;
  background: rgba(40, 40, 40, 0.5);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  padding: 8px;
}
.card-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  flex-direction: column;
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  width: 100%;
  cursor: grab;
}
.card-wrapper:active {
  cursor: grabbing;
}
.step-card {
  flex: 0 0 auto;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 8px 12px;
  gap: 12px;
  overflow-y: auto;
  overflow-x: hidden;
}

@media (min-height: 800px) {
  .step-card {
    padding: 10px 14px;
    gap: 14px;
  }
}
.step-card-device {
  flex-shrink: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 1;
}
.step-card-title {
  font-size: 19px;
  font-weight: 700;
  color: #00ffff;
  margin-bottom: 6px;
  text-align: center;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.step-card-text {
  font-size: 17px;
  line-height: 1.4;
  opacity: 0.9;
  text-align: center;
  max-width: 400px;
  padding: 12px 16px;
  flex-shrink: 0;
  background: rgba(17, 17, 17, 0.6);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
  z-index: 10;
}

@media (min-height: 800px) {
  .step-card-title {
    font-size: 21px;
    margin-bottom: 8px;
  }
  .step-card-text {
    font-size: 18px;
    padding: 14px 18px;
  }
}
.card-dots {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 10;
  pointer-events: all;
}
.card-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #333;
  transition: all 0.3s;
  cursor: pointer;
}
.card-dot.active {
  background: #00ffff;
  width: 12px;
  height: 12px;
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
}
.swipe-hint {
  text-align: center;
  font-size: 12px;
  opacity: 0.6;
  padding: 6px 0;
  animation: fadeInOut 3s ease-in-out infinite;
  position: absolute;
  bottom: 8px;
  left: 0;
  right: 0;
  pointer-events: none;
  color: #00ffff;
}
@keyframes fadeInOut {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.7; }
}

.how-to-measure {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}
.device-column {
  flex: 0 0 100px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.text-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.mini-device {
  width: 100px;
  height: 160px;
  position: relative;
}
.mini-device-body {
  position: absolute;
  inset: 0;
  background: #232347;
  border-radius: 60px/84px;
  box-shadow: 0 6px 20px rgba(0,0,0,.85), inset 0 1px 3px rgba(255,255,255,.08);
}
.mini-device-body::before {
  content: "";
  position: absolute;
  left: 0;
  width: 100%;
  height: 16px;
  background: #141414;
  z-index: 2;
  top: -12px;
}
.mini-device-body::after {
  content: "";
  position: absolute;
  left: 0;
  width: 100%;
  height: 48px;
  background: #141414;
  z-index: 2;
  bottom: -42px;
}
.mini-device-seam {
  position: absolute;
  left: 10%;
  width: 80%;
  height: 1px;
  top: 18%;
  background: linear-gradient(to bottom, rgba(255,255,255,.18), rgba(0,0,0,.45));
  z-index: 4;
}
.mini-device-screen {
  position: absolute;
  top: 22%;
  left: 50%;
  transform: translateX(-50%);
  width: 70px;
  height: 70px;
  background: #000;
  border-radius: 8px;
  box-shadow: inset 0 1px 6px rgba(0,0,0,.7), 0 0 0 2px #333;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3;
}
.mini-device-screen svg {
  width: 100%;
  height: 100%;
}
.mini-device-buttons {
  position: absolute;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  width: 72px;
  height: 24px;
  z-index: 3;
}
.mini-device-btn-circle {
  position: absolute;
  left: 50%;
  bottom: 7px;
  transform: translateX(-50%);
  width: 28px;
  height: 28px;
  background: #0ff;
  border-radius: 50%;
}
.mini-device-btn-triangle {
  position: absolute;
  left: 0;
  bottom: 20px;
  width: 17px;
  height: 17px;
  background: #ff9800;
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}
.mini-device-mouthpiece {
  position: absolute;
  top: 7px;
  right: -7px;
  width: 36px;
  height: 20px;
  background: #fff;
  border-radius: 5px;
  transform-origin: left center;
  transform: rotate(-45deg);
  box-shadow: 0 1px 4px rgba(0,0,0,.4);
  z-index: 5;
}

/* Full-size device styles */
.device-frame{
  width:200px;
  height:320px;
  position:relative;
  margin:0 auto;
  flex-shrink: 1;
  transform: scale(1.1);
}

/* Scale up device on taller screens */
@media (min-height: 750px) {
  .device-frame {
    transform: scale(1.2);
  }
}

@media (min-height: 900px) {
  .device-frame {
    transform: scale(1.3);
  }
}

@media (min-height: 1100px) {
  .device-frame {
    transform: scale(1.4);
  }
}
.device-body{
  position:absolute;inset:0;background:#232347;border-radius:100px/140px;
  box-shadow:0 10px 30px rgba(0,0,0,.85), inset 0 2px 4px rgba(255,255,255,.10);
  z-index:1
}
.device-body::before{
  content:"";position:absolute;left:0;width:100%;height:26px;background:#141414;z-index:2;top:-20px;
}
.device-body::after{
  content:"";position:absolute;left:0;width:100%;height:78px;background:#141414;z-index:2;bottom:-66px;
}
.device-seam{
  position:absolute;left:10%;width:80%;height:2px;top:18%;
  background:linear-gradient(to bottom, rgba(255,255,255,.18), rgba(0,0,0,.45));
  z-index:4
}
.device-screen{
  position:absolute;top:22%;left:50%;transform:translateX(-50%);
  width:140px;height:140px;background:#000;border-radius:14px;
  box-shadow:inset 0 2px 10px rgba(0,0,0,.7), 0 0 0 3px #333;
  display:flex;align-items:center;justify-content:center;z-index:3;overflow:hidden
}
.device-screen svg{width:100%;height:100%}
.device-buttons{
  position:absolute;bottom:30px;left:50%;transform:translateX(-50%);
  width:120px;height:40px;z-index:3
}
.device-btn-circle{
  position:absolute;left:50%;transform:translateX(-50%);
  bottom:11px;width:46px;height:46px;background:#0ff;border-radius:50%;
  box-shadow:0 2px 10px rgba(0,255,255,.35)
}
.device-btn-triangle{
  position:absolute;left:0;bottom:34px;width:29px;height:29px;background:#ff9800;
  clip-path:polygon(50% 100%,0 0,100% 0);
  box-shadow:0 2px 10px rgba(255,152,0,.35)
}
.device-mouthpiece{
  position:absolute;top:11px;right:-11px;width:60px;height:34px;background:#fff;border-radius:8px;
  transform-origin:left center;transform:rotate(-45deg);
  box-shadow:0 2px 6px rgba(0,0,0,.4);
  z-index:6
}

.step-block {
  background: #111;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 14px;
  height: 160px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.step-title {
  font-size: 17px;
  font-weight: 600;
  color: #00ffff;
  margin-bottom: 8px;
}
.step-text {
  font-size: 16px;
  line-height: 1.5;
  opacity: .85;
}

.title { 
  font-size: 30px; 
  font-weight: 700; 
  text-align: center; 
  margin-top: 16px;
  margin-bottom: 0;
  padding-bottom: 4px;
  line-height: 1.2;
  flex-shrink: 0;
  border-bottom: 1px solid rgba(0, 255, 255, 0.3);
}

@media (min-height: 800px) {
  .title {
    font-size: 34px;
    margin-top: 20px;
    margin-bottom: 0;
    padding-bottom: 6px;
  }
}
.subtitle { 
  font-size: 18px; 
  opacity: .7; 
  text-align: center; 
  margin-bottom: 20px; 
  line-height: 1.4; 
  padding: 0 10px;
  flex-shrink: 0;
}

.dots { display:flex; gap:8px; justify-content:center; margin:6px 0; flex-shrink:0; }
.dot {
  width:8px; height:8px; border-radius:50%;
  background:#333; transition:all .3s;
}
.dot.active { background:#00ffff; width:24px; }

.btn-row { display:flex; gap:10px; padding-top:6px; flex-shrink:0; }
.btn {
  flex:1; padding:12px; border-radius:10px; border:none;
  font-size:16px; font-weight:600; cursor:pointer;
  transition:all .2s;
  touch-action: manipulation;
  user-select: none;
}
.btn:active { transform: scale(0.95); }

@media (min-height: 800px) {
  .btn {
    padding: 14px;
    font-size: 17px;
  }
}
.btn-primary { background:#00ffff; color:#000; }
.btn-secondary { background:#222; color:#fff; }
.btn-full { width:100%; }

.form-group { margin-bottom:20px; }
.form-label { 
  display:block; margin-bottom:6px; font-size:14px; 
  font-weight:500; opacity:.9;
}
.form-input {
  width:100%; padding:14px; border-radius:12px; border:2px solid #333;
  background:#111; color:#fff; font-size:16px;
}
.form-input:focus { outline:none; border-color:#00ffff; }

.level-grid {
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:12px; margin-top:12px;
}
.level-btn {
  aspect-ratio:1; border-radius:12px;
  border:3px solid transparent; cursor:pointer;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  font-size:24px; font-weight:700;
  transition:all .2s;
  touch-action: manipulation;
  user-select: none;
}
.level-btn:active { transform: scale(0.95); }
.level-btn.selected {
  border-color:#00ffff;
  box-shadow:0 0 20px 8px rgba(0,255,255,0.6);
}
.level-1 { background:#2196F3; color:#000; }
.level-2 { background:#4CAF50; color:#000; }
.level-3 { background:#9C27B0; color:#fff; }
.level-4 { background:#E91E63; color:#fff; }
.level-hint {
  text-align: center;
  margin: 24px auto;
  font-size: 18px;
  font-weight: 600;
  padding: 16px 64px;
  border-radius: 40px;
  display: inline-block;
  width: fit-content;
  color: #000;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}
.screen.active { animation:fadeIn .4s ease-out; }

.spacer { flex: 0 0 8px; }

.info-box {
  background:#111; border:1px solid #333; border-radius:12px;
  padding:16px; margin:16px 0;
}
.info-title { 
  font-size:19px; font-weight:600; color:#00ffff; 
  margin-bottom:10px;
}
.info-text { font-size:18px; line-height:1.5; opacity:.85; }

.info-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.info-list li {
  position: relative;
  padding-left: 16px;
  margin-bottom: 8px;
}
.info-list li:last-child {
  margin-bottom: 0;
}
.info-list li:before {
  content: "â€¢";
  position: absolute;
  left: 0;
  color: #00ffff;
  font-weight: bold;
}
</style>
</head>
<body>
<div class="container">
  <div id="content" style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden"></div>
  <div class="dots" id="dots"></div>
  <div class="btn-row" id="buttons"></div>
</div>

<script>
var selectedLevel = 1;
var target2 = 60;
var target3 = 120;
var customLevelValue = target3 + 10;
var hints = ['no target', 'total = ' + target2, 'total = ' + target3, 'custom: ' + customLevelValue];
var showOnboarding = true;

var state = 0;

function getMenuSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<rect x="158" y="15" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="17" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="17" width="14" height="6" fill="#0f0"/>' +
    '<text x="30" y="22" font-size="11" fill="#0ff">2/6/26</text>' +
    '<rect x="14" y="55" width="156" height="32" rx="16" fill="#00ffff"/>' +
    '<text x="92" y="76" font-size="24" font-weight="700" fill="#000" text-anchor="middle">Measure</text>' +
    '<text x="92" y="108" font-size="24" fill="#fff" text-anchor="middle">Data</text>' +
    '<text x="92" y="138" font-size="24" fill="#fff" text-anchor="middle">About</text>' +
    '<text x="92" y="168" font-size="24" fill="#fff" text-anchor="middle">Off</text></svg>';
}

function getWarmupSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<rect x="158" y="15" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="17" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="17" width="14" height="6" fill="#0f0"/>' +
    '<text x="92" y="120" font-size="72" font-weight="700" fill="#0ff" text-anchor="middle">37</text>' +
    '<circle cx="92" cy="92" r="70" fill="none" stroke="#004444" stroke-width="12"/>' +
    '<circle cx="92" cy="92" r="70" fill="none" stroke="#00ffff" stroke-width="12" ' +
    'stroke-dasharray="440" stroke-dashoffset="110" transform="rotate(-90 92 92)" stroke-linecap="round"/></svg>';
}

function getBlowSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<rect x="158" y="15" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="17" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="17" width="14" height="6" fill="#0f0"/>' +
    '<text x="92" y="110" font-size="48" font-weight="700" fill="#0ff" text-anchor="middle">blow</text></svg>';
}

function getZoneSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<rect x="55" y="7" width="74" height="16" rx="8" fill="#00ffff"/>' +
    '<text x="92" y="18" font-size="11" font-weight="700" fill="#1a1a2e" text-anchor="middle">NOW</text>' +
    '<rect x="158" y="15" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="17" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="17" width="14" height="6" fill="#0f0"/>' +
    '<path d="M 32.0,105.0 A 60,60 0 0,1 34.3,88.5" fill="none" stroke="#00ffff" stroke-width="18"/>' +
    '<path d="M 34.9,86.5 A 60,60 0 0,1 42.3,71.4" fill="none" stroke="#00ffff" stroke-width="18"/>' +
    '<path d="M 43.5,69.7 A 60,60 0 0,1 55.1,57.7" fill="none" stroke="#00ffff" stroke-width="18"/>' +
    '<path d="M 56.7,56.5 A 60,60 0 0,1 71.5,48.6" fill="none" stroke="#004444" stroke-width="18"/>' +
    '<path d="M 73.5,47.9 A 60,60 0 0,1 89.9,45.0" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 92.0,45.0 A 60,60 0 0,1 108.5,47.3" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 110.5,47.9 A 60,60 0 0,1 125.6,55.3" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 127.3,56.5 A 60,60 0 0,1 139.3,68.1" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 140.5,69.7 A 60,60 0 0,1 148.4,84.5" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 149.1,86.5 A 60,60 0 0,1 152.0,102.9" fill="none" stroke="#004400" stroke-width="18"/>' +
    '<path d="M 38,108 A 54,54 0 0,1 146,108" fill="none" stroke="#ffffff" stroke-width="2"/>' +
    '<line x1="92" y1="50" x2="92" y2="55" stroke="#ffffff" stroke-width="2"/>' +
    '<line x1="38" y1="108" x2="43" y2="108" stroke="#ffffff" stroke-width="2"/>' +
    '<line x1="146" y1="108" x2="141" y2="108" stroke="#ffffff" stroke-width="2"/>' +
    '<text x="92" y="125" font-size="60" font-weight="700" fill="#00ffff" text-anchor="middle">3</text>' +
    '<text x="92" y="165" font-size="24" font-weight="700" fill="#00ffff" text-anchor="middle">Good!</text></svg>';
}

function getTotalSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    // TODAY header with rounded yellow background
    '<rect x="66" y="5" width="52" height="16" rx="8" fill="#f5c842"/>' +
    '<text x="92" y="17" font-size="11" font-weight="700" fill="#1a1a2e" text-anchor="middle">TODAY</text>' +
    
    // Battery indicator (top right)
    '<rect x="158" y="10" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="12" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="12" width="14" height="6" fill="#0f0"/>' +
    
    // Graph area - yellow filled area with inverted curve
    '<path d="M 8,100 L 8,44 Q 35,65 62,70 L 80,80 L 80,100 Z" fill="#f5c842"/>' +
    
    // Data point dots (white circles with values)
    '<circle cx="62" cy="70" r="3" fill="#fff"/>' +
    '<circle cx="80" cy="80" r="3" fill="#fff"/>' +
    
    // Dashed dark grey line below the 3 measurement point
    '<line x1="80" y1="80" x2="170" y2="80" stroke="#666" stroke-width="1" stroke-dasharray="4,4"/>' +
    
    // Data point values (white text)
    '<text x="62" y="62" font-size="14" font-weight="700" fill="#fff" text-anchor="middle">4</text>' +
    '<text x="80" y="72" font-size="14" font-weight="700" fill="#fff" text-anchor="middle">3</text>' +
    
    // X-axis baseline
    '<line x1="8" y1="100" x2="170" y2="100" stroke="#fff" stroke-width="1"/>' +
    
    // Time labels below graph (white)
    '<text x="8" y="115" font-size="12" fill="#fff" text-anchor="start">0a</text>' +
    '<text x="92" y="115" font-size="12" fill="#fff" text-anchor="middle">12p</text>' +
    '<text x="170" y="115" font-size="12" fill="#fff" text-anchor="end">12a</text>' +
    
    // Large value display (centered group)
    '<text x="68" y="160" font-size="40" font-weight="700" fill="#ff9800" text-anchor="middle">47</text>' +
    '<text x="101" y="155" font-size="40" font-weight="700" fill="#fff" text-anchor="middle">/</text>' +
    
    // Heart icon (centered with group) - outline only
    '<path d="M 128,123 C 123,119 119,121 119,126 C 119,131 128,137 128,137 C 128,137 137,131 137,126 C 137,121 133,119 128,123 Z" fill="none" stroke="#ff4444" stroke-width="2"/>' +
    
    // Target value (20px, dark grey)
    '<text x="111" y="160" font-size="20" font-weight="700" fill="#666" text-anchor="start">60</text>' +
    
    // Status dots at bottom
    '<circle cx="75" cy="170" r="4" fill="#fff"/>' +
    '<circle cx="92" cy="170" r="4" fill="none" stroke="#888" stroke-width="2"/>' +
    '<circle cx="109" cy="170" r="4" fill="none" stroke="#888" stroke-width="2"/>' +
    
    '</svg>';
}

function getSummaryScreenSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    // TODAY header with rounded yellow background (larger)
    '<rect x="56" y="8" width="72" height="22" rx="11" fill="#f5c842"/>' +
    '<text x="92" y="23" font-size="15" font-weight="700" fill="#1a1a2e" text-anchor="middle">TODAY</text>' +
    
    // Battery indicator (top right)
    '<rect x="158" y="12" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="14" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="14" width="14" height="6" fill="#0f0"/>' +
    
    // Graph area - yellow filled area with inverted curve (scaled up)
    '<path d="M 12,110 L 12,54 Q 42,80 72,85 L 100,97 L 100,110 Z" fill="#f5c842"/>' +
    
    // Data point dots (white circles with values)
    '<circle cx="72" cy="85" r="4" fill="#fff"/>' +
    '<circle cx="100" cy="97" r="4" fill="#fff"/>' +
    
    // Dashed dark grey line below the 3 measurement point
    '<line x1="100" y1="97" x2="172" y2="97" stroke="#666" stroke-width="1.5" stroke-dasharray="4,4"/>' +
    
    // Data point values (white text)
    '<text x="72" y="76" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">4</text>' +
    '<text x="100" y="88" font-size="18" font-weight="700" fill="#fff" text-anchor="middle">3</text>' +
    
    // X-axis baseline
    '<line x1="12" y1="110" x2="172" y2="110" stroke="#fff" stroke-width="1.5"/>' +
    
    // Time labels below graph (white)
    '<text x="12" y="125" font-size="14" fill="#fff" text-anchor="start">0a</text>' +
    '<text x="92" y="125" font-size="14" fill="#fff" text-anchor="middle">12p</text>' +
    '<text x="172" y="125" font-size="14" fill="#fff" text-anchor="end">12a</text>' +
    
    // Large value display (centered group) - scaled up
    '<text x="60" y="172" font-size="48" font-weight="700" fill="#ff9800" text-anchor="middle">47</text>' +
    '<text x="99" y="166" font-size="48" font-weight="700" fill="#fff" text-anchor="middle">/</text>' +
    
    // Heart icon (centered with group) - outline only, scaled up, moved up and centered over 60
    '<path d="M 130,132 C 124,127 119,130 119,136 C 119,142 130,150 130,150 C 130,150 141,142 141,136 C 141,130 136,127 130,132 Z" fill="none" stroke="#ff4444" stroke-width="2.5"/>' +
    
    // Target value (24px, dark grey) - scaled up
    '<text x="118" y="172" font-size="24" font-weight="700" fill="#666" text-anchor="start">60</text>' +
    
    '</svg>';
}

function getStreaksSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<rect x="42" y="5" width="100" height="20" rx="10" fill="#9C27B0"/>' +
    '<text x="92" y="19" font-size="12" font-weight="700" fill="#1a1a2e" text-anchor="middle">5 Day</text>' +
    '<rect x="158" y="15" width="18" height="10" rx="2" stroke="#0ff" stroke-width="1" fill="none"/>' +
    '<rect x="176" y="17" width="2" height="6" fill="#0ff"/>' +
    '<rect x="160" y="17" width="14" height="6" fill="#0f0"/>' +
    '<g transform="translate(22,50)">' +
      '<line x1="0" y1="30" x2="140" y2="30" stroke="#ffffff" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/>' +
      '<rect x="4" y="8" width="24" height="42" rx="4" fill="#FF9800"/>' +
      '<text x="16" y="30" font-size="10" font-weight="700" fill="#1a1a2e" text-anchor="middle">102</text>' +
      '<text x="16" y="60" font-size="11" fill="#00ffff" text-anchor="middle">s</text>' +
      '<rect x="32" y="12" width="24" height="38" rx="4" fill="#FF9800"/>' +
      '<text x="44" y="34" font-size="10" font-weight="700" fill="#1a1a2e" text-anchor="middle">94</text>' +
      '<text x="44" y="60" font-size="11" fill="#00ffff" text-anchor="middle">m</text>' +
      '<rect x="60" y="4" width="24" height="46" rx="4" fill="#FF9800"/>' +
      '<text x="72" y="30" font-size="10" font-weight="700" fill="#1a1a2e" text-anchor="middle">114</text>' +
      '<text x="72" y="60" font-size="11" fill="#00ffff" text-anchor="middle">t</text>' +
      '<rect x="88" y="10" width="24" height="40" rx="4" fill="#FF9800"/>' +
      '<text x="100" y="33" font-size="10" font-weight="700" fill="#1a1a2e" text-anchor="middle">97</text>' +
      '<text x="100" y="60" font-size="11" fill="#00ffff" text-anchor="middle">w</text>' +
      '<rect x="116" y="24" width="24" height="26" rx="4" fill="#FFEB3B"/>' +
      '<text x="128" y="40" font-size="10" font-weight="700" fill="#1a1a2e" text-anchor="middle">67</text>' +
      '<text x="128" y="60" font-size="12" font-weight="700" fill="#FFEB3B" text-anchor="middle">t</text>' +
      '<line x1="0" y1="50" x2="140" y2="50" stroke="#ffffff" stroke-width="1.5"/>' +
    '</g>' +
    '<g transform="translate(0,130)">' +
      '<circle cx="50" cy="20" r="18" fill="#9C27B0" stroke="#555" stroke-width="2"/>' +
      '<text x="50" y="28" font-size="20" font-weight="700" fill="#FFEB3B" text-anchor="middle">8</text>' +
      '<text x="50" y="45" font-size="11" fill="#00ffff" text-anchor="middle">best</text>' +
      '<circle cx="134" cy="20" r="18" fill="#FFEB3B" stroke="#555" stroke-width="2"/>' +
      '<text x="134" y="28" font-size="20" font-weight="700" fill="#1a1a2e" text-anchor="middle">5</text>' +
      '<text x="134" y="45" font-size="11" fill="#00ffff" text-anchor="middle">now</text>' +
    '</g></svg>';
}

function getBackPanelSVG() {
  return '<svg viewBox="0 0 184 184" xmlns="http://www.w3.org/2000/svg">' +
    '<defs><pattern id="texture" x="0" y="0" width="4" height="4" patternUnits="userSpaceOnUse">' +
      '<circle cx="2" cy="2" r="0.5" fill="#333" opacity="0.6"/>' +
    '</pattern></defs>' +
    '<rect x="0" y="0" width="184" height="184" fill="url(#texture)"/>' +
    '<circle cx="92" cy="30" r="12.75" fill="#1a1a1a"/>' +
    '<rect x="25.5" y="58" width="25.5" height="25.5" fill="#000"/>' +
    '<rect x="131" y="58" width="25.5" height="25.5" fill="#000"/>' +
    '<rect x="57" y="99" width="70" height="70" rx="9" fill="#1a1a1a" stroke="#333" stroke-width="1"/>' +
    '<g transform="translate(92, 134)">' +
      '<circle cx="0" cy="0" r="31.5" fill="#0a0a0a" stroke="#333" stroke-width="1"/>' +
      '<line x1="0" y1="-24.75" x2="0" y2="-9" stroke="#666" stroke-width="3.4" stroke-linecap="round"/>' +
      '<line x1="0" y1="9" x2="0" y2="24.75" stroke="#666" stroke-width="3.4" stroke-linecap="round"/>' +
      '<line x1="-24.75" y1="0" x2="-9" y2="0" stroke="#666" stroke-width="3.4" stroke-linecap="round"/>' +
      '<line x1="9" y1="0" x2="24.75" y2="0" stroke="#666" stroke-width="3.4" stroke-linecap="round"/>' +
      '<line x1="-17.44" y1="-17.44" x2="-6.19" y2="-6.19" stroke="#555" stroke-width="2.25" stroke-linecap="round"/>' +
      '<line x1="6.19" y1="6.19" x2="17.44" y2="17.44" stroke="#555" stroke-width="2.25" stroke-linecap="round"/>' +
      '<line x1="17.44" y1="-17.44" x2="6.19" y2="-6.19" stroke="#555" stroke-width="2.25" stroke-linecap="round"/>' +
      '<line x1="-6.19" y1="6.19" x2="-17.44" y2="17.44" stroke="#555" stroke-width="2.25" stroke-linecap="round"/>' +
      '<circle cx="0" cy="0" r="2.25" fill="#888"/>' +
    '</g>' +
  '</svg>';
}

var render = function() {
  console.log('render() called, state:', state);
  
  // Scroll to top of page
  window.scrollTo(0, 0);
  
  var content = '';
  var buttons = '';
  
  if (state === 0) {
    // 1. WELCOME / ORIENTATION
    content = '<div class="welcome">' +
      '<div class="logo">FOX2</div>' +
      '<div class="tagline">Understand your metabolic health</div>' +
      '<div class="content-text">' +
        '<p>FOX2 provides insight into how your body is using energy by measuring a natural signal in your breath.</p>' +
        '<p><strong>No needles. No lab tests.</strong><br>Just a normal breath.</p>' +
        '<p style="opacity:0.6; font-size:13px; margin-top:24px">FOX2 provides informational insight and is not a medical diagnostic device.</p>' +
      '</div></div>';
    buttons = '<button class="btn btn-secondary" onclick="skipToSetup()">Skip to Setup</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 1) {
    // 2. WHAT FOX2 MEASURES
    content = '<div class="title">What FOX2 Measures</div>' +
      '<div class="content-text">' +
        '<p>Your body draws its energy from glucose when available and from stored fat when glucose runs low. The balance between these two fuels shifts dynamically - hour to hour and day to day.</p>' +
        '<p>When your body shifts to using more fat for energy, small amounts of <strong>acetone</strong> are naturally released into your breath. FOX2 measures this breath signal to give insight into your current metabolic state.</p>' +
        '<p>Regular measurements help you make strategic choices. Time your meals to extend fat-burning periods, identify which foods keep you in fat metabolism longer, or discover the best timing for exercise to match your goals.</p>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 2) {
    // 3. HOW IT WORKS - Device overview
    content = '<div class="title">How It Works</div>' +
      '<div class="card-container" style="overflow-y: auto;">' +
        '<div class="info-box">' +
          '<div class="info-title">Controls</div>' +
          '<div class="info-text">' +
            'Press and hold <span style="color: #00ffff; font-weight: 600;">● Circle</span> to power on.' +
            '<div style="margin-top: 12px; display: flex; justify-content: center;">' +
              '<div style="text-align: left;">' +
                '<div style="margin-bottom: 8px;"><span style="color: #ff9800; font-weight: 600;">▼ Triangle:</span> Move down menu</div>' +
                '<div><span style="color: #00ffff; font-weight: 600;">● Circle:</span> Select</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div style="display: flex; gap: 20px; margin-bottom: 24px; align-items: center; justify-content: center;">' +
          '<div style="flex: 0 0 auto; margin-top: 32px;">' +
            '<div class="device-frame">' +
              '<div class="device-body"></div>' +
              '<div class="device-seam"></div>' +
              '<div class="device-screen">' + getMenuSVG() + '</div>' +
              '<div class="device-buttons">' +
                '<div class="device-btn-triangle"></div>' +
                '<div class="device-btn-circle"></div>' +
              '</div>' +
              '<div class="device-mouthpiece"></div>' +
            '</div>' +
          '</div>' +
          '<div style="flex: 0 0 auto;">' +
            '<ul style="list-style: none; padding: 0; margin: 0; max-width: 250px; font-size: 17px;">' +
              '<li style="display: flex; align-items: flex-start; margin-bottom: 14px;">' +
                '<span style="color: #00ffff; font-weight: 700; margin-right: 12px; flex-shrink: 0;">●</span>' +
                '<div><span style="font-weight: 600; color: #00ffff;">Measure</span> - Take reading</div>' +
              '</li>' +
              '<li style="display: flex; align-items: flex-start; margin-bottom: 14px;">' +
                '<span style="color: #00ffff; font-weight: 700; margin-right: 12px; flex-shrink: 0;">●</span>' +
                '<div><span style="font-weight: 600; color: #00ffff;">Data</span> - View results</div>' +
              '</li>' +
              '<li style="display: flex; align-items: flex-start; margin-bottom: 14px;">' +
                '<span style="color: #00ffff; font-weight: 700; margin-right: 12px; flex-shrink: 0;">●</span>' +
                '<div><span style="font-weight: 600; color: #00ffff;">About</span> - Settings</div>' +
              '</li>' +
              '<li style="display: flex; align-items: flex-start;">' +
                '<span style="color: #00ffff; font-weight: 700; margin-right: 12px; flex-shrink: 0;">●</span>' +
                '<div><span style="font-weight: 600; color: #00ffff;">Off</span> - Power off</div>' +
              '</li>' +
            '</ul>' +
          '</div>' +
        '</div>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 3) {
    // 4. HOW TO TAKE A MEASUREMENT - Swipeable cards
    content = '<div class="title">Taking a Measurement</div>' +
      '<div class="card-container">' +
        '<div class="card-wrapper" id="cardWrapper3">' +
          // Card 1
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Step 1: Select Measure</div>' +
              'Navigate to Measure and press the circle button to start.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getMenuSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // Card 2
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Step 2: Wait for Warmup</div>' +
              'Breathe normally during the countdown.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getWarmupSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // Card 3
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Step 3: Blow</div>' +
              'When it says "Blow," breathe in then blow steadily into the mouthpiece until it buzzes.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getBlowSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // Card 4 - Tips
          '<div class="step-card">' +
            '<div class="step-card-title">Quick Tips</div>' +
            '<div style="text-align: left; font-size: 17px; line-height: 1.6; max-width: 350px; background: rgba(17, 17, 17, 0.6); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px 18px;">' +
              '<div style="margin-bottom: 12px;">• Don\'t cover the vents</div>' +
              '<div style="margin-bottom: 12px;">• Wait 1 hour after eating</div>' +
              '<div>• Avoid alcohol beforehand</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card-dots" id="cardDots3">' +
          '<div class="card-dot active"></div>' +
          '<div class="card-dot"></div>' +
          '<div class="card-dot"></div>' +
          '<div class="card-dot"></div>' +
        '</div>' +
        '<div class="swipe-hint">↑ Swipe up/down ↓</div>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 4) {
    // 5. UNDERSTANDING YOUR RESULTS - Swipeable cards
    content = '<div class="title">Understanding Results</div>' +
      '<div class="card-container">' +
        '<div class="card-wrapper" id="cardWrapper4">' +
          // Card 1 - Zone
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Zone Reading</div>' +
              'Shows your current metabolic state. Higher numbers mean more fat burning, lower means more glucose burning.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getZoneSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // Card 2 - Total
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Daily Total</div>' +
              'Your measurements accumulate throughout the day. Your target is shown below if you\'ve set one.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getTotalSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // Card 3 - Streaks
          '<div class="step-card">' +
            '<div class="step-card-text">' +
              '<div class="step-card-title">Streaks</div>' +
              'Hit your daily target to build streaks. "Best" shows your longest ever, "Now" shows your current streak.' +
            '</div>' +
            '<div class="step-card-device">' +
              '<div class="device-frame">' +
                '<div class="device-body"></div>' +
                '<div class="device-seam"></div>' +
                '<div class="device-screen">' + getStreaksSVG() + '</div>' +
                '<div class="device-buttons">' +
                  '<div class="device-btn-triangle"></div>' +
                  '<div class="device-btn-circle"></div>' +
                '</div>' +
                '<div class="device-mouthpiece"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="card-dots" id="cardDots4">' +
          '<div class="card-dot active"></div>' +
          '<div class="card-dot"></div>' +
          '<div class="card-dot"></div>' +
        '</div>' +
        '<div class="swipe-hint">↑ Swipe up/down ↓</div>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 5) {
    // 6. USING FOX2 OVER TIME
    content = '<div class="title">Daily Use</div>' +
      '<div class="info-box">' +
        '<div style="color: #00ffff; font-size: 18px; font-weight: 600; margin-bottom: 8px;">Summary Screen</div>' +
        '<div class="info-text">' +
          'When you power on after taking measurements, you\'ll see a summary of your last three readings and daily total.' +
        '</div>' +
      '</div>' +
      '<div style="display: flex; gap: 20px; margin-bottom: 24px; align-items: center; justify-content: center;">' +
        '<div style="flex: 0 0 auto; margin-top: 32px;">' +
          '<div class="device-frame">' +
            '<div class="device-body"></div>' +
            '<div class="device-seam"></div>' +
            '<div class="device-screen">' + getSummaryScreenSVG() + '</div>' +
            '<div class="device-buttons">' +
              '<div class="device-btn-triangle"></div>' +
              '<div class="device-btn-circle"></div>' +
            '</div>' +
            '<div class="device-mouthpiece"></div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="content-text">' +
        '<p>The SUMMARY screen is a quick way to see your progress so far today. This data screen as well as your daily TOTAL and STREAKS screens can always be accessed from the DATA menu. Other data screens can also be accessed from there including your TODAY GRAPH screen (useful for seeing daily trends in zone measurements) and your 21 DAY screen (useful for seeing weekly trends in your daily totals.</p>' +
        '<p>Rather than focusing on any single reading, the most useful insights come from noticing how measurements change and repeat over time.</p>' +
        '<div class="info-box">' +
          '<div class="info-title">When to Measure</div>' +
          '<div class="info-text">' +
            'There is no single "correct" time to measure, but consistency helps make patterns easier to see.<br><br>' +
            'Many people find it helpful to measure:<br>' +
            '<ul class="info-list">' +
              '<li>In the morning</li>' +
              '<li>At similar times each day</li>' +
              '<li>Before or after meals</li>' +
              '<li>On both active and rest days</li>' +
            '</ul>' +
          '</div>' +
        '</div>' +
        '<div class="info-box">' +
          '<div class="info-title">What to Watch For</div>' +
          '<div class="info-text">' +
            'Over days and weeks, you may begin to notice:<br>' +
            '<ul class="info-list">' +
              '<li>Daily rhythms</li>' +
              '<li>Differences between weekdays and weekends</li>' +
              '<li>How meals, activity, or rest affect readings</li>' +
              '<li>Gradual changes over time</li>' +
            '</ul>' +
          '</div>' +
        '</div>' +
        '<p>Daily totals help you compare days to yourself and reveal longer-term trends.</p>' +
        '<p><strong>A steady approach</strong> â€” measuring regularly and staying curious â€” is often the most helpful.</p>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Next</button>';
              
  } else if (state === 6) {
    // 7. SAFETY & SUPPORT
    content = '<div class="title">Safety & Support</div>' +
      '<div class="card-container" style="overflow-y: auto;">' +
        '<div class="content-text">' +
          '<p>FOX2 is designed to provide insight into metabolic patterns using a non-invasive breath measurement.</p>' +
          '<p style="opacity:0.6; font-size:13px">It is not a medical diagnostic device and is not intended to diagnose, treat, cure, or prevent any disease.</p>' +
          '<div class="info-box">' +
            '<div class="info-title">When to Talk to a Clinician</div>' +
            '<div class="info-text">' +
              'If you have a medical condition, are pregnant, or have concerns about your metabolic health, ' +
              'it is appropriate to discuss your results with a qualified healthcare professional.' +
            '</div>' +
          '</div>' +
          '<div class="info-box">' +
            '<div class="info-title">Using FOX2 Safely</div>' +
            '<div class="info-text">' +
              '<ul class="info-list">' +
                '<li>Follow the instructions provided</li>' +
                '<li>Avoid forced or excessive breathing</li>' +
                '<li>Take breaks if you feel lightheaded</li>' +
              '</ul>' +
              '<br>If anything feels uncomfortable, stop and resume later.' +
            '</div>' +
          '</div>' +
          '<p>We are here to help you use FOX2 with confidence.</p>' +
        '</div>' +
      '</div>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="next()">Setup</button>';
              
  } else if (state === 7) {
    // SETUP PAGE
    var sel1 = selectedLevel === 1 ? ' selected' : '';
    var sel2 = selectedLevel === 2 ? ' selected' : '';
    var sel3 = selectedLevel === 3 ? ' selected' : '';
    var sel4 = selectedLevel === 4 ? ' selected' : '';
    content = '<div class="title">Setup FOX2</div>' +
      '<div class="subtitle">Configure your device preferences</div>' +
      '<form id="f" onsubmit="save(event)">' +
        '<div class="form-group">' +
          '<label class="form-label">Target Level</label>' +
          '<div style="display: flex; gap: 16px; flex-direction: column; row-gap: 16px;">' +
            '<div style="display: flex; gap: 12px; align-items: center;">' +
              '<div class="level-btn level-1' + sel1 + '" onclick="selectLevel(1)" style="width: 60px; height: 60px; margin: 0; aspect-ratio: auto; flex-shrink: 0;">1</div>' +
              '<div style="background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; flex: 1;">' +
                '<strong style="color: #2196F3; font-size: 14px;">Level 1</strong>' +
                '<div style="font-size: 12px; color: #aaa; margin-top: 4px; line-height: 1.4;">Select this level if you would like no daily target or streaks displayed. This is a great place to start just to get an idea of where you are!</div>' +
              '</div>' +
            '</div>' +
            '<div style="display: flex; gap: 12px; align-items: center;">' +
              '<div class="level-btn level-2' + sel2 + '" onclick="selectLevel(2)" style="width: 60px; height: 60px; margin: 0; aspect-ratio: auto; flex-shrink: 0;">2</div>' +
              '<div style="background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; flex: 1;">' +
                '<strong style="color: #4CAF50; font-size: 14px;">Level 2</strong>' +
                '<div style="font-size: 12px; color: #aaa; margin-top: 4px; line-height: 1.4;">This is a great maintenance or starting level. Achieving this target means you have increased fat metabolism.</div>' +
              '</div>' +
            '</div>' +
            '<div style="display: flex; gap: 12px; align-items: center;">' +
              '<div class="level-btn level-3' + sel3 + '" onclick="selectLevel(3)" style="width: 60px; height: 60px; margin: 0; aspect-ratio: auto; flex-shrink: 0;">3</div>' +
              '<div style="background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; flex: 1;">' +
                '<strong style="color: #9C27B0; font-size: 14px;">Level 3</strong>' +
                '<div style="font-size: 12px; color: #aaa; margin-top: 4px; line-height: 1.4;">This is a good level for losing weight, hitting this target will likely require changing both diet and exercise.</div>' +
              '</div>' +
            '</div>' +
            '<div style="display: flex; gap: 12px; align-items: center;">' +
              '<div class="level-btn level-4' + sel4 + '" onclick="selectLevel(4)" style="width: 60px; height: 60px; margin: 0; aspect-ratio: auto; flex-shrink: 0;">C</div>' +
              '<div style="background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; flex: 1;">' +
                '<strong style="color: #E91E63; font-size: 14px;">Level C</strong>' +
                '<div style="font-size: 12px; color: #aaa; margin-top: 4px; line-height: 1.4;">You can adjust a custom target here.</div>' +
              '</div>' +
              '<div style="display: flex; flex-direction: column; gap: 6px;">' +
                '<button type="button" onclick="incrementCustomLevel()" style="background: #E91E63; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 16px; font-weight: bold;">▲</button>' +
                '<button type="button" onclick="decrementCustomLevel()" style="background: #E91E63; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 16px; font-weight: bold;">▼</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div style="text-align: center;">' +
            '<div class="level-hint" id="hint">' + hints[selectedLevel - 1] + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="form-group">' +
          '<div style="font-size: 12px; color: #aaa; margin-bottom: 12px; line-height: 1.4;">Check this box and type in an email address to send the data email after saving and exiting this page.</div>' +
          '<div style="display: flex; gap: 12px; align-items: center;">' +
            '<input type="checkbox" id="email-check" name="email-check" style="width: 27px; height: 27px; cursor: pointer; flex-shrink: 0;">' +
            '<input class="form-input" name="email" type="email" placeholder="your@email.com" style="margin: 0;">' +
          '</div>' +
        '</div>' +
        '<input type="hidden" name="level" value="' + selectedLevel + '">' +
        '<input type="hidden" name="epoch" value="' + Math.floor(Date.now() / 1000) + '">' +
        '<input type="hidden" name="tzoffset" value="' + new Date().getTimezoneOffset() + '">' +
      '</form>';
    buttons = '<button class="btn btn-secondary" onclick="back()">Back</button>' +
              '<button class="btn btn-primary" onclick="document.getElementById(\'f\').dispatchEvent(new Event(\'submit\'))">Save and Exit</button>';
  }
  
  document.getElementById('content').innerHTML = content;
  document.getElementById('buttons').innerHTML = buttons;
  
  // Spacer removed to save space on mobile
  /*
  var container = document.querySelector('.container');
  var existingSpacer = document.getElementById('spacer');
  if (existingSpacer) {
    existingSpacer.remove();
  }
  var spacerDiv = document.createElement('div');
  spacerDiv.id = 'spacer';
  spacerDiv.className = 'spacer';
  var dotsElement = document.getElementById('dots');
  container.insertBefore(spacerDiv, dotsElement);
  */
  
  var dotsContainer = document.getElementById('dots');
  if (showOnboarding) {
    var dotsHtml = '';
    for (var i = 0; i < 8; i++) {
      dotsHtml += '<div class="dot' + (i === state ? ' active' : '') + '"></div>';
    }
    dotsContainer.innerHTML = dotsHtml;
    dotsContainer.style.display = 'flex';
  } else {
    dotsContainer.innerHTML = '';
    dotsContainer.style.display = 'none';
  }
  
  // Initialize hint color if on Setup page
  if (state === 7) {
    setTimeout(function() {
      var hintElement = document.getElementById('hint');
      if (hintElement) {
        var colors = ['#2196F3', '#4CAF50', '#9C27B0', '#E91E63'];
        hintElement.style.backgroundColor = colors[selectedLevel - 1];
      }
    }, 0);
  }
  
  // Initialize swipe handlers for card-based screens
  if (state === 3) {
    initCardSwipe('cardWrapper3', 'cardDots3', 4);
  } else if (state === 4) {
    initCardSwipe('cardWrapper4', 'cardDots4', 3);
  }
};

// Card swipe functionality
function initCardSwipe(wrapperId, dotsId, cardCount) {
  var wrapper = document.getElementById(wrapperId);
  var dots = document.getElementById(dotsId);
  if (!wrapper || !dots) return;
  
  var container = wrapper.parentElement;
  var containerHeight = container.offsetHeight;
  
  // Set each card to exact container height
  var cards = wrapper.querySelectorAll('.step-card');
  cards.forEach(function(card) {
    card.style.height = containerHeight + 'px';
  });
  
  var currentCard = 0;
  var startY = 0;
  var currentY = 0;
  var isDragging = false;
  
  function updateCard(index) {
    currentCard = Math.max(0, Math.min(index, cardCount - 1));
    wrapper.style.transform = 'translateY(-' + (currentCard * containerHeight) + 'px)';
    
    // Update dots
    var dotElements = dots.querySelectorAll('.card-dot');
    dotElements.forEach(function(dot, i) {
      if (i === currentCard) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }
  
  wrapper.addEventListener('touchstart', function(e) {
    startY = e.touches[0].clientY;
    isDragging = true;
    wrapper.style.transition = 'none';
  });
  
  wrapper.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    var diff = currentY - startY;
    var offset = -(currentCard * containerHeight) + diff;
    wrapper.style.transform = 'translateY(' + offset + 'px)';
  });
  
  wrapper.addEventListener('touchend', function(e) {
    if (!isDragging) return;
    isDragging = false;
    wrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    var diff = currentY - startY;
    if (Math.abs(diff) > 50) {
      // Swipe down (positive diff) = go to previous card
      // Swipe up (negative diff) = go to next card
      if (diff > 0 && currentCard > 0) {
        updateCard(currentCard - 1);
      } else if (diff < 0 && currentCard < cardCount - 1) {
        updateCard(currentCard + 1);
      } else {
        updateCard(currentCard);
      }
    } else {
      updateCard(currentCard);
    }
  });
  
  // Mouse event handlers for desktop/laptop
  wrapper.addEventListener('mousedown', function(e) {
    startY = e.clientY;
    isDragging = true;
    wrapper.style.transition = 'none';
    e.preventDefault(); // Prevent text selection
  });
  
  wrapper.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    currentY = e.clientY;
    var diff = currentY - startY;
    var offset = -(currentCard * containerHeight) + diff;
    wrapper.style.transform = 'translateY(' + offset + 'px)';
  });
  
  wrapper.addEventListener('mouseup', function(e) {
    if (!isDragging) return;
    isDragging = false;
    wrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    var diff = currentY - startY;
    if (Math.abs(diff) > 50) {
      // Swipe down (positive diff) = go to previous card
      // Swipe up (negative diff) = go to next card
      if (diff > 0 && currentCard > 0) {
        updateCard(currentCard - 1);
      } else if (diff < 0 && currentCard < cardCount - 1) {
        updateCard(currentCard + 1);
      } else {
        updateCard(currentCard);
      }
    } else {
      updateCard(currentCard);
    }
  });
  
  // Handle mouse leaving the wrapper while dragging
  wrapper.addEventListener('mouseleave', function(e) {
    if (!isDragging) return;
    isDragging = false;
    wrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    updateCard(currentCard); // Snap back to current card
  });
  
  // Click on dots to navigate
  var dotElements = dots.querySelectorAll('.card-dot');
  dotElements.forEach(function(dot, index) {
    dot.addEventListener('click', function() {
      updateCard(index);
    });
  });
  
  // Initialize first card
  updateCard(0);
}

var next = function() { 
  if (state < 7) { 
    state++; 
    render(); 
  } 
};

var back = function() { 
  if (state > 0) { 
    state--; 
    render(); 
  } 
};

var cancel = function() {
  alert('Setup cancelled');
};

var skipToSetup = function() {
  state = 7;
  render();
};

var selectLevel = function(l) { 
  selectedLevel = l;
  var hintElement = document.getElementById('hint');
  hintElement.textContent = hints[l - 1];
  
  // Set color based on selected level
  var colors = ['#2196F3', '#4CAF50', '#9C27B0', '#E91E63'];
  hintElement.style.backgroundColor = colors[l - 1];
  
  // Update visual selection for all level buttons
  for (var i = 1; i <= 4; i++) {
    var buttons = document.querySelectorAll('.level-btn');
    if (buttons[i - 1]) {
      if (i === l) {
        buttons[i - 1].classList.add('selected');
      } else {
        buttons[i - 1].classList.remove('selected');
      }
    }
  }
  
  // Only full render if NOT Level C (4) - Level C requires arrow clicks to change target
  if (l !== 4) {
    render();
  }
};

var incrementCustomLevel = function() {
  customLevelValue += 10;
  hints[3] = 'custom: ' + customLevelValue;
  var hintElement = document.getElementById('hint');
  hintElement.textContent = hints[3];
  hintElement.style.backgroundColor = '#E91E63';
};

var decrementCustomLevel = function() {
  if (customLevelValue > 10) {
    customLevelValue -= 10;
  }
  hints[3] = 'custom: ' + customLevelValue;
  var hintElement = document.getElementById('hint');
  hintElement.textContent = hints[3];
  hintElement.style.backgroundColor = '#E91E63';
};

var save = function(e) {
  e.preventDefault();
  alert('Setup complete! (This is just a test - no data is saved)');
};

render();

// Initialize hint color on page load
setTimeout(function() {
  var hintElement = document.getElementById('hint');
  if (hintElement) {
    var colors = ['#2196F3', '#4CAF50', '#9C27B0', '#E91E63'];
    hintElement.style.backgroundColor = colors[selectedLevel - 1];
  }
}, 100);
</script>
</body>
</html>
